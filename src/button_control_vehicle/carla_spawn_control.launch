<launch>
  <!-- ====================== 公共参数配置 ====================== -->
  <!-- 车辆角色名（统一所有节点的车辆标识） -->
  <arg name="role_name" default="ego_vehicle"/>
  
  <!-- ====================== CARLA 连接参数 ====================== -->
  <arg name="host" default="localhost"/>
  <arg name="port" default="2000"/>
  <arg name="timeout" default="60"/>
  <arg name="town" default="Town01"/>
  
  <!-- ====================== Carla 生成物体参数 ====================== -->
  <!-- 物体定义文件路径 -->
  <arg name="objects_definition_file" default='$(find carla_spawn_objects)/config/objects.json'/>
  <!-- 车辆生成位置 "x,y,z,roll,pitch,yaw"，留空则使用默认位置 -->
  <arg name="spawn_point_ego_vehicle" default=""/>
  <!-- 是否仅生成传感器（不生成车辆） -->
  <arg name="spawn_sensors_only" default="false"/>

  <!-- ====================== 同步模式参数 ====================== -->
  <arg name="synchronous_mode" default="True"/>
  <arg name="synchronous_mode_wait_for_vehicle_control_command" default="False"/>
  <arg name="fixed_delta_seconds" default="0.05"/>

  <!-- 设置仿真时间源为CARLA -->
  <param name="use_sim_time" value="True"/>


  <!-- ====================== 1. 启动 CARLA ROS Bridge（核心桥接节点） ====================== -->
  <node 
    pkg="carla_ros_bridge" 
    name="carla_ros_bridge" 
    type="bridge.py" 
    output="screen" 
    required="true"
  >
    <param name="host" value="$(arg host)"/>
    <param name="port" value="$(arg port)"/>
    <param name="timeout" value="$(arg timeout)"/>
    <param name="passive" value="False"/>
    <param name="synchronous_mode" value="$(arg synchronous_mode)"/>
    <param name="synchronous_mode_wait_for_vehicle_control_command" value="$(arg synchronous_mode_wait_for_vehicle_control_command)"/>
    <param name="fixed_delta_seconds" value="$(arg fixed_delta_seconds)"/>
    <param name="register_all_sensors" value="True"/>
    <param name="town" value="$(arg town)"/>
    <param name="ego_vehicle_role_name" value='["hero", "ego_vehicle", "hero0", "hero1", "hero2", "hero3", "hero4", "hero5", "hero6", "hero7", "hero8", "hero9"]'/>
  </node>


  <!-- ====================== 2. 启动 Carla 生成物体节点 ====================== -->
  <node 
    pkg="carla_spawn_objects" 
    type="carla_spawn_objects.py" 
    name="$(anon carla_spawn_objects)" 
    output="screen"
    required="true"
    launch-prefix="bash -c 'sleep 3; $0 $@' "
  >
    <param name="objects_definition_file" value="$(arg objects_definition_file)" />
    <param name="spawn_point_$(arg role_name)" value="$(arg spawn_point_ego_vehicle)" />
    <param name="spawn_sensors_only" value="$(arg spawn_sensors_only)" />
    <param name="role_name" value="$(arg role_name)"/>
  </node>


  <!-- ====================== 3. 启动 Carla 路径点发布节点 ====================== -->
  <node 
    pkg="carla_waypoint_publisher" 
    type="carla_waypoint_publisher.py" 
    name="carla_waypoint_publisher" 
    output="screen"
    launch-prefix="bash -c 'sleep 5; $0 $@' "
  >
    <param name="role_name" value="$(arg role_name)"/>
    <param name="host" value="$(arg host)"/>
    <param name="port" value="$(arg port)"/>
    <param name="timeout" value="$(arg timeout)"/>
  </node>


  <!-- ====================== 4. 启动 Carla 手动控制节点 ====================== -->
  <node 
    pkg="carla_manual_control" 
    type="carla_manual_control.py" 
    name="carla_manual_control_$(arg role_name)" 
    output="screen"
    required="true"
    launch-prefix="bash -c 'sleep 6; $0 $@' "
  >
    <param name="role_name" value="$(arg role_name)"/>
  </node>

</launch>