# CARLA目标检测与跟踪系统

这是一个基于CARLA仿真环境的目标检测与跟踪系统，使用YOLOv5作为检测模型，结合改进的SORT算法实现多目标跟踪，并利用深度信息提升跟踪性能。

## 功能特点

- 连接CARLA仿真环境，生成主车辆和NPC车辆
- 使用YOLOv5模型进行实时目标检测
- 基于改进的SORT算法实现多目标跟踪，结合卡尔曼滤波预测
- 利用深度相机数据计算目标距离和速度
- 实时性能监控与可视化
- 支持多种YOLOv5模型选择，可根据硬件性能调整

## 安装依赖

```bash
# 基础依赖
pip install numpy opencv-python torch torchvision
pip install carla  # 请根据CARLA版本安装对应版本
pip install scipy argparse
```

## 使用方法

```bash
python main.py [参数选项]
```

### 参数说明

| 参数 | 说明 | 可选值 | 默认值 |
|------|------|--------|--------|
| --model | 选择YOLOv5模型 | yolov5s, yolov5su, yolov5m, yolov5mu, yolov5x | yolov5mu |
| --tracker | 选择跟踪算法 | sort | sort |
| --host | CARLA服务器地址 | - | localhost |
| --port | CARLA服务器端口 | - | 2000 |
| --conf-thres | 检测置信度阈值 | 0-1 | 0.15 |
| --iou-thres | IOU阈值 | 0-1 | 0.4 |
| --use-depth | 是否使用深度相机 | - | True |
| --show-depth | 是否显示深度图像 | - | False |
| --npc-count | NPC车辆数量 | - | 30 |

## 系统架构

1. **CARLA环境交互模块**：负责连接CARLA服务器，生成车辆和传感器
2. **传感器数据获取模块**：获取RGB图像和深度图像数据
3. **目标检测模块**：使用YOLOv5模型检测图像中的车辆目标
4. **目标跟踪模块**：基于改进的SORT算法，结合卡尔曼滤波实现多目标跟踪
5. **可视化模块**：实时显示检测和跟踪结果，以及性能监控信息

## 核心算法说明

### 卡尔曼滤波器

实现了一个针对目标跟踪优化的卡尔曼滤波器，根据目标距离动态调整过程噪声协方差矩阵Q：
- 远距离目标（>50m）：增大Q值，允许更大的预测误差
- 中距离目标（30-50m）：中等Q值
- 近距离目标（<30m）：减小Q值，提高跟踪稳定性

### 改进的SORT跟踪算法

在标准SORT算法基础上进行了以下改进：
- 结合深度信息动态调整IOU阈值
- 对不同距离的目标使用不同的尺寸过滤条件
- 对远距离目标延长跟踪保留时间
- 使用加权平滑处理目标中心位置，提高跟踪稳定性
- 基于距离变化计算目标速度

## 操作说明

- 运行程序后，系统会自动连接CARLA并生成仿真环境
- 按 'q' 键退出程序
- 按 'r' 键重新生成NPC车辆

## 性能监控

系统提供实时性能监控面板，显示各阶段耗时：
- CARLA同步时间
- 图像获取时间
- 深度图像处理时间
- 目标检测时间
- 目标跟踪时间
- 结果绘制时间
- 显示输出时间

每50帧会打印一次性能统计信息，并自动识别性能瓶颈并给出优化建议。

## 优化建议

- 若检测耗时过长，可尝试使用更小的模型（如yolov5s）或降低检测分辨率
- 若跟踪耗时过长，可减少NPC车辆数量
- 若CARLA同步耗时过长，可降低仿真频率或减少场景复杂度
- 对于远距离目标检测，可调整检测阈值以提高检测率

## 注意事项

- 确保CARLA服务器已启动并正常运行
- 根据硬件性能选择合适的模型，高性能GPU推荐使用yolov5x，CPU或低性能GPU推荐使用yolov5s
- 深度相机数据处理可能会增加系统负载，若性能不足可关闭（--use-depth=False）