import time
import random  # ä»…ç”¨äºæ¨¡æ‹Ÿç¡¬ä»¶é‡‡é›†çš„ç”µæ± ç”µå‹æ•°æ®ï¼Œå®é™…é¡¹ç›®éƒ¨ç½²æ—¶è¯·åˆ é™¤è¯¥æ¨¡å—åŠç›¸å…³æ¨¡æ‹Ÿä»£ç 


class UnmannedVehicleBattery:
    """æ— äººè½¦ç”µæ± ç”µé‡ç®¡ç†æ ¸å¿ƒç±»
    è´Ÿè´£ç”µæ± ç”µå‹è¯»å–ã€å‰©ä½™ç”µé‡è®¡ç®—ã€çŠ¶æ€åˆ¤æ–­åŠå¯è§†åŒ–å±•ç¤ºï¼Œ
    æ”¯æŒå¯¹æ¥å®é™…ç¡¬ä»¶é‡‡é›†æ¨¡å—ï¼Œå¯æ ¹æ®ç”µæ± è§„æ ¼çµæ´»é…ç½®å‚æ•°ã€‚
    """

    def __init__(self):
        # ç”µæ± æ ¸å¿ƒå‚æ•°é…ç½®ï¼ˆå¯æ ¹æ®å®é™…ä½¿ç”¨çš„ç”µæ± å‹å·/è§„æ ¼è°ƒæ•´å¯¹åº”æ•°å€¼ï¼‰
        self.max_voltage = 12.6  # ç”µæ± æ»¡ç”µç”µå‹ï¼ˆä»¥12Vä¸‰å…ƒé”‚ç”µæ± ä¸ºä¾‹ï¼‰
        self.min_voltage = 10.0  # ç”µæ± æ¬ å‹ä¿æŠ¤ç”µå‹ï¼Œä½äºæ­¤å€¼éœ€ç«‹å³åœæ­¢ä½¿ç”¨å¹¶å……ç”µ
        self.current_voltage = 0.0  # ç”µæ± å®æ—¶ç”µå‹ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œé€šè¿‡ç¡¬ä»¶é‡‡é›†æˆ–æ¨¡æ‹Ÿæ›´æ–°ï¼‰
        self.battery_percent = 0.0  # ç”µæ± å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”ï¼ˆä¿ç•™1ä½å°æ•°ï¼‰

    def read_battery_voltage(self):
        """è¯»å–ç”µæ± å®æ—¶ç”µå‹ï¼ˆæ¨¡æ‹Ÿç¡¬ä»¶é‡‡é›†é€»è¾‘ï¼‰
        å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œéœ€æ›¿æ¢ä¸ºå¯¹åº”ç¡¬ä»¶çš„æ•°æ®é‡‡é›†æ–¹å¼ï¼š
        1. æ ‘è“æ´¾/å•ç‰‡æœºï¼šé€šè¿‡ADCæ¨¡å—ï¼ˆå¦‚ADS1115ï¼‰é‡‡é›†ç”µå‹ä¿¡å·
        2. å¸¦BMSçš„ç”µæ± ï¼šé€šè¿‡ä¸²å£/RS485/I2Cé€šä¿¡è·å–BMSä¸ŠæŠ¥çš„ç”µå‹æ•°æ®
        3. å…¶ä»–ç¡¬ä»¶ï¼šæ ¹æ®å¯¹åº”é€šä¿¡åè®®è°ƒæ•´æ•°æ®è¯»å–é€»è¾‘
        """
        # æ¨¡æ‹Ÿç”µå‹å°å¹…æ³¢åŠ¨ï¼ˆèŒƒå›´ï¼šæ¬ å‹ä¿æŠ¤ç”µå‹~æ»¡ç”µç”µå‹ï¼Œä¿ç•™2ä½å°æ•°ï¼‰
        self.current_voltage = round(random.uniform(10.0, 12.6), 2)

        # å®é™…ç¡¬ä»¶é‡‡é›†ç¤ºä¾‹ï¼ˆä»¥æ ‘è“æ´¾+ADS1115 ADCæ¨¡å—ä¸ºä¾‹ï¼Œéœ€å®‰è£…å¯¹åº”ä¾èµ–åº“ï¼‰
        # ä¾èµ–åº“å®‰è£…ï¼špip install adafruit-circuitpython-ads1x15
        # import board
        # import adafruit_ads1x15.ads1115 as ADS
        # from adafruit_ads1x15.analog_in import AnalogIn
        #
        # # åˆå§‹åŒ–I2Cæ€»çº¿å’ŒADS1115æ¨¡å—
        # i2c = board.I2C()  # é»˜è®¤ä½¿ç”¨SDA/SCLå¼•è„š
        # ads = ADS.ADS1115(i2c)
        # chan = AnalogIn(ads, ADS.P0)  # é€‰æ‹©A0é€šé“ä½œä¸ºç”µå‹é‡‡é›†é€šé“
        #
        # # è®¡ç®—å®é™…ç”µæ± ç”µå‹ï¼ˆéœ€æ ¹æ®åˆ†å‹ç”µè·¯é…ç½®å¯¹åº”çš„ç”µå‹åˆ†å‹æ¯”ï¼‰
        # voltage_divider_ratio = 2.0  # åˆ†å‹æ¯”ç¤ºä¾‹ï¼Œéœ€æ ¹æ®å®é™…ç”µè·¯è°ƒæ•´
        # self.current_voltage = chan.voltage * voltage_divider_ratio

    def calculate_battery_percent(self):
        """æ ¹æ®å®æ—¶ç”µå‹è®¡ç®—ç”µæ± å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
        é‡‡ç”¨çº¿æ€§è®¡ç®—æ¨¡å‹ï¼ˆé€‚ç”¨äºç”µå‹ä¸ç”µé‡è¿‘ä¼¼çº¿æ€§çš„ç”µæ± ç±»å‹ï¼‰ï¼Œ
        å®é™…åœºæ™¯ä¸­å¯æ ¹æ®ç”µæ± æ”¾ç”µæ›²çº¿ä¼˜åŒ–ä¸ºéçº¿æ€§è®¡ç®—æ¨¡å‹ï¼Œæå‡ç²¾åº¦ã€‚
        """
        if self.current_voltage >= self.max_voltage:
            # ç”µå‹è¾¾åˆ°æ»¡ç”µç”µå‹ï¼Œåˆ¤å®šä¸º100%ç”µé‡
            self.battery_percent = 100.0
        elif self.current_voltage <= self.min_voltage:
            # ç”µå‹ä½äºæ¬ å‹ä¿æŠ¤å€¼ï¼Œåˆ¤å®šä¸º0%ç”µé‡ï¼ˆéœ€ç«‹å³å……ç”µï¼‰
            self.battery_percent = 0.0
        else:
            # çº¿æ€§æ’å€¼è®¡ç®—å‰©ä½™ç”µé‡ï¼Œä¿ç•™1ä½å°æ•°ï¼Œä¿è¯æ˜¾ç¤ºç²¾åº¦
            self.battery_percent = round(
                (self.current_voltage - self.min_voltage) /
                (self.max_voltage - self.min_voltage) * 100,
                1
            )

    def get_battery_status(self):
        """æ ¹æ®å‰©ä½™ç”µé‡åˆ¤æ–­ç”µæ± å½“å‰çŠ¶æ€
        è¿”å›å€¼è¯´æ˜ï¼š
        - ç¬¬ä¸€ä¸ªè¿”å›å€¼ï¼šæ–‡å­—çŠ¶æ€æè¿°ï¼ˆæ»¡ç”µ/æ­£å¸¸/ä½ç”µé‡/ç´§æ€¥ï¼‰
        - ç¬¬äºŒä¸ªè¿”å›å€¼ï¼šçŠ¶æ€æ ‡è¯†ç¬¦å·ï¼ˆå¯¹åº”ä¸åŒå‘Šè­¦çº§åˆ«ï¼‰
        """
        if self.battery_percent >= 95:
            return "æ»¡ç”µ", "ğŸŸ¢"
        elif 20 <= self.battery_percent < 95:
            return "æ­£å¸¸", "ğŸŸ¢"
        elif 5 <= self.battery_percent < 20:
            return "ä½ç”µé‡", "ğŸŸ¡"
        else:
            return "ç´§æ€¥ï¼ˆè¯·å……ç”µï¼‰", "ğŸ”´"

    def display_battery_info(self):
        """å¯è§†åŒ–å±•ç¤ºç”µæ± å®Œæ•´ä¿¡æ¯
        åŒ…æ‹¬å®æ—¶ç”µå‹ã€å‰©ä½™ç”µé‡è¿›åº¦æ¡ã€å½“å‰çŠ¶æ€ï¼Œ
        ä½ç”µé‡æ—¶è§¦å‘é¢å¤–å‘Šè­¦æç¤ºï¼Œæå‡ä½¿ç”¨å®‰å…¨æ€§ã€‚
        """
        # æ¸…ç©ºæ§åˆ¶å°å±å¹•ï¼ˆå¯é€‰åŠŸèƒ½ï¼Œæ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯é€‰æ‹©æ˜¯å¦å¯ç”¨ï¼‰
        # å…¼å®¹Windowså’ŒLinux/macOSç³»ç»Ÿ
        # import os
        # os.system('cls' if os.name == 'nt' else 'clear')

        # ç”µé‡è¿›åº¦æ¡å¯è§†åŒ–é…ç½®
        bar_length = 20  # è¿›åº¦æ¡æ€»é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰
        filled_length = int(bar_length * self.battery_percent // 100)  # å·²å¡«å……è¿›åº¦é•¿åº¦
        battery_bar = "â–ˆ" * filled_length + "-" * (bar_length - filled_length)  # æ‹¼æ¥è¿›åº¦æ¡

        # è·å–å½“å‰ç”µæ± çŠ¶æ€æè¿°å’ŒçŠ¶æ€æ ‡è¯†
        status, color = self.get_battery_status()

        # æ‰“å°æ ¼å¼åŒ–åçš„ç”µæ± ä¿¡æ¯
        print(f"\n=== æ— äººè½¦ç”µæ± çŠ¶æ€ç›‘æ§ ===")
        print(f"å½“å‰ç”µå‹: {self.current_voltage}V")
        print(f"å‰©ä½™ç”µé‡: |{battery_bar}| {self.battery_percent}%")
        print(f"çŠ¶æ€: {color} {status}")

        # ç´§æ€¥å‘Šè­¦ï¼šç”µé‡ä½äº5%æ—¶ï¼Œæç¤ºç«‹å³åœæ­¢ä½œä¸šå¹¶å……ç”µ
        if self.battery_percent < 5:
            print("âš ï¸  ã€ç´§æ€¥å‘Šè­¦ã€‘ç”µé‡è¿‡ä½ï¼Œç«‹å³åœæ­¢æ‰€æœ‰ä½œä¸šå¹¶æ¥å…¥å……ç”µå™¨ï¼")


def main():
    """ç¨‹åºä¸»å…¥å£ï¼Œå®ç°ç”µæ± çŠ¶æ€å¾ªç¯ç›‘æ§
    åˆå§‹åŒ–ç”µæ± ç®¡ç†å¯¹è±¡ï¼ŒæŒç»­æ‰§è¡Œã€Œç”µå‹è¯»å–â†’ç”µé‡è®¡ç®—â†’ä¿¡æ¯å±•ç¤ºã€æµç¨‹ï¼Œ
    æ”¯æŒé€šè¿‡Ctrl+Cå¿«æ·é”®æ­£å¸¸é€€å‡ºç›‘æ§ç¨‹åºã€‚
    """
    # åˆå§‹åŒ–æ— äººè½¦ç”µæ± ç®¡ç†å®ä¾‹
    battery = UnmannedVehicleBattery()
    print("æ— äººè½¦ç”µé‡ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨...ï¼ˆæŒ‰Ctrl+Cå¯é€€å‡ºç›‘æ§ï¼‰")

    try:
        # æ— é™å¾ªç¯æ‰§è¡Œç›‘æ§æµç¨‹ï¼Œæ¯ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
        while True:
            battery.read_battery_voltage()  # æ­¥éª¤1ï¼šè¯»å–ç”µæ± å®æ—¶ç”µå‹
            battery.calculate_battery_percent()  # æ­¥éª¤2ï¼šè®¡ç®—å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
            battery.display_battery_info()  # æ­¥éª¤3ï¼šå¯è§†åŒ–å±•ç¤ºç”µæ± çŠ¶æ€
            time.sleep(1)  # è®¾ç½®åˆ·æ–°é—´éš”ä¸º1ç§’ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´
    except KeyboardInterrupt:
        # æ•è·Ctrl+Cä¸­æ–­ä¿¡å·ï¼Œå‹å¥½é€€å‡ºç¨‹åº
        print("\nç›‘æ§ç³»ç»Ÿå·²æ­£å¸¸é€€å‡º")


if __name__ == "__main__":
    # ç¨‹åºå¯åŠ¨æ—¶ï¼Œç›´æ¥æ‰§è¡Œä¸»å‡½æ•°
    main()