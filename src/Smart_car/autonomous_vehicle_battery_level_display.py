import time
import random  # ä»…ç”¨äºæ¨¡æ‹Ÿç¡¬ä»¶é‡‡é›†çš„ç”µæ± ç”µå‹æ•°æ®ï¼Œå®é™…é¡¹ç›®éƒ¨ç½²æ—¶è¯·åˆ é™¤è¯¥æ¨¡å—åŠç›¸å…³æ¨¡æ‹Ÿä»£ç 


class UnmannedVehicleBattery:
    """æ— äººè½¦ç”µæ± ç”µé‡ç®¡ç†æ ¸å¿ƒç±»
    æ ¸å¿ƒèŒè´£ï¼š
    1. ç”µæ± å®æ—¶ç”µå‹æ•°æ®è¯»å–ï¼ˆæ”¯æŒå¯¹æ¥å®é™…ç¡¬ä»¶æˆ–æ¨¡æ‹Ÿé‡‡é›†ï¼‰
    2. åŸºäºç”µå‹å€¼è®¡ç®—å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
    3. æ ¹æ®å‰©ä½™ç”µé‡åˆ¤æ–­ç”µæ± å·¥ä½œçŠ¶æ€
    4. æ ¼å¼åŒ–ã€å¯è§†åŒ–å±•ç¤ºç”µæ± å®Œæ•´ç›‘æ§ä¿¡æ¯
    ç‰¹æ€§ï¼š
    - å¯æ ¹æ®ç”µæ± å‹å·/è§„æ ¼çµæ´»é…ç½®æ ¸å¿ƒå‚æ•°ï¼ˆæ»¡ç”µç”µå‹ã€æ¬ å‹ä¿æŠ¤ç”µå‹ç­‰ï¼‰
    - é¢„ç•™ç¡¬ä»¶é‡‡é›†å¯¹æ¥æ¥å£ï¼Œæ˜“äºå®é™…é¡¹ç›®éƒ¨ç½²è¿ç§»
    """

    def __init__(self):
        # ç”µæ± æ ¸å¿ƒå‚æ•°é…ç½®ï¼ˆå¯æ ¹æ®å®é™…ä½¿ç”¨çš„ç”µæ± å‹å·/è§„æ ¼è°ƒæ•´å¯¹åº”æ•°å€¼ï¼‰
        self.max_voltage = 12.6  # ç”µæ± æ»¡ç”µç”µå‹ï¼ˆç¤ºä¾‹ï¼š12Vä¸‰å…ƒé”‚ç”µæ± æ»¡ç”µç”µå‹ï¼‰
        self.min_voltage = 10.0  # ç”µæ± æ¬ å‹ä¿æŠ¤ç”µå‹ï¼Œä½äºæ­¤å€¼éœ€ç«‹å³åœæ­¢ä½¿ç”¨å¹¶å……ç”µ
        self.current_voltage = 0.0  # ç”µæ± å®æ—¶ç”µå‹ï¼ˆåˆå§‹å€¼ä¸º0ï¼Œåç»­é€šè¿‡ç¡¬ä»¶é‡‡é›†æˆ–æ¨¡æ‹Ÿé€»è¾‘æ›´æ–°ï¼‰
        self.battery_percent = 0.0  # ç”µæ± å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”ï¼ˆè®¡ç®—åä¿ç•™1ä½å°æ•°ï¼Œä¿è¯æ˜¾ç¤ºç²¾åº¦ï¼‰

    def read_battery_voltage(self):
        """è¯»å–ç”µæ± å®æ—¶ç”µå‹ï¼ˆæ¨¡æ‹Ÿç¡¬ä»¶é‡‡é›†é€»è¾‘ï¼‰
        å®é™…åº”ç”¨åœºæ™¯å¯¹æ¥è¯´æ˜ï¼š
        1. æ ‘è“æ´¾/å•ç‰‡æœºå¹³å°ï¼šé€šè¿‡ADCæ¨¡å—ï¼ˆå¦‚ADS1115ï¼‰é‡‡é›†ç”µå‹æ¨¡æ‹Ÿä¿¡å·
        2. å¸¦BMSç®¡ç†ç³»ç»Ÿçš„ç”µæ± ï¼šé€šè¿‡ä¸²å£/RS485/I2Cé€šä¿¡åè®®è·å–BMSä¸ŠæŠ¥çš„ç”µå‹æ•°æ®
        3. å…¶ä»–ç¡¬ä»¶å¹³å°ï¼šæ ¹æ®å¯¹åº”ç¡¬ä»¶çš„é€šä¿¡åè®®è°ƒæ•´æ•°æ®è¯»å–é€»è¾‘
        æœ¬æ–¹æ³•ä¸­æ¨¡æ‹Ÿé€»è¾‘ä»…ç”¨äºæµ‹è¯•æ¼”ç¤ºï¼Œå®é™…éƒ¨ç½²éœ€æ›¿æ¢ä¸ºçœŸå®ç¡¬ä»¶é‡‡é›†ä»£ç 
        """
        # æ¨¡æ‹Ÿç”µå‹å°å¹…æ³¢åŠ¨ï¼ˆèŒƒå›´ï¼šæ¬ å‹ä¿æŠ¤ç”µå‹~æ»¡ç”µç”µå‹ï¼Œä¿ç•™2ä½å°æ•°ï¼Œè´´è¿‘çœŸå®ç”µæ± ç”µå‹å˜åŒ–ï¼‰
        self.current_voltage = round(random.uniform(10.0, 12.6), 2)

        # å®é™…ç¡¬ä»¶é‡‡é›†ç¤ºä¾‹ï¼ˆä»¥æ ‘è“æ´¾+ADS1115 ADCæ¨¡å—ä¸ºä¾‹ï¼Œéœ€å®‰è£…å¯¹åº”ä¾èµ–åº“ï¼‰
        # ä¾èµ–åº“å®‰è£…å‘½ä»¤ï¼špip install adafruit-circuitpython-ads1x15
        # import board
        # import adafruit_ads1x15.ads1115 as ADS
        # from adafruit_ads1x15.analog_in import AnalogIn
        #
        # # åˆå§‹åŒ–I2Cæ€»çº¿å’ŒADS1115æ¨¡å—ï¼ˆä½¿ç”¨ç¡¬ä»¶é»˜è®¤SDA/SCLå¼•è„šï¼‰
        # i2c = board.I2C()
        # ads = ADS.ADS1115(i2c)
        # chan = AnalogIn(ads, ADS.P0)  # é€‰æ‹©A0é€šé“ä½œä¸ºç”µæ± ç”µå‹é‡‡é›†é€šé“
        #
        # # è®¡ç®—å®é™…ç”µæ± ç”µå‹ï¼ˆéœ€æ ¹æ®ç¡¬ä»¶åˆ†å‹ç”µè·¯é…ç½®ï¼Œè°ƒæ•´å¯¹åº”çš„ç”µå‹åˆ†å‹æ¯”ï¼‰
        # voltage_divider_ratio = 2.0  # åˆ†å‹æ¯”ç¤ºä¾‹ï¼Œéœ€æ ¹æ®å®é™…ç”µè·¯å‚æ•°ä¿®æ”¹
        # self.current_voltage = chan.voltage * voltage_divider_ratio

    def calculate_battery_percent(self):
        """æ ¹æ®å®æ—¶ç”µå‹è®¡ç®—ç”µæ± å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
        è®¡ç®—æ¨¡å‹è¯´æ˜ï¼š
        - é‡‡ç”¨çº¿æ€§è®¡ç®—æ¨¡å‹ï¼Œé€‚ç”¨äºç”µå‹ä¸ç”µé‡è¿‘ä¼¼çº¿æ€§å…³ç³»çš„ç”µæ± ç±»å‹ï¼ˆå¦‚ä¸‰å…ƒé”‚ç”µæ± ï¼‰
        - å®é™…åœºæ™¯ä¼˜åŒ–å»ºè®®ï¼šå¯æ ¹æ®ç”µæ± å…·ä½“æ”¾ç”µæ›²çº¿ï¼Œä¼˜åŒ–ä¸ºéçº¿æ€§è®¡ç®—æ¨¡å‹ï¼Œæå‡ç”µé‡è®¡ç®—ç²¾åº¦
        è®¡ç®—é€»è¾‘ï¼š
        1. ç”µå‹â‰¥æ»¡ç”µç”µå‹ï¼šåˆ¤å®šä¸º100%æ»¡ç”µé‡
        2. ç”µå‹â‰¤æ¬ å‹ä¿æŠ¤ç”µå‹ï¼šåˆ¤å®šä¸º0%ç”µé‡ï¼ˆéœ€ç«‹å³åœæ­¢ä½¿ç”¨ï¼‰
        3. ç”µå‹åœ¨ä¸¤è€…ä¹‹é—´ï¼šé€šè¿‡çº¿æ€§æ’å€¼å…¬å¼è®¡ç®—å‰©ä½™ç”µé‡ï¼Œä¿ç•™1ä½å°æ•°
        """
        if self.current_voltage >= self.max_voltage:
            # ç”µå‹è¾¾åˆ°æ»¡ç”µé˜ˆå€¼ï¼Œåˆ¤å®šä¸º100%å‰©ä½™ç”µé‡
            self.battery_percent = 100.0
        elif self.current_voltage <= self.min_voltage:
            # ç”µå‹ä½äºæ¬ å‹ä¿æŠ¤é˜ˆå€¼ï¼Œåˆ¤å®šä¸º0%å‰©ä½™ç”µé‡ï¼ˆéœ€ç«‹å³å……ç”µï¼‰
            self.battery_percent = 0.0
        else:
            # çº¿æ€§æ’å€¼è®¡ç®—å‰©ä½™ç”µé‡ï¼Œä¿ç•™1ä½å°æ•°ï¼Œä¿è¯æ˜¾ç¤ºä¸€è‡´æ€§
            self.battery_percent = round(
                (self.current_voltage - self.min_voltage) /
                (self.max_voltage - self.min_voltage) * 100,
                1
            )

    def get_battery_status(self):
        """æ ¹æ®å‰©ä½™ç”µé‡åˆ¤æ–­ç”µæ± å½“å‰å·¥ä½œçŠ¶æ€
        è¿”å›å€¼è¯´æ˜ï¼š
        - ç¬¬ä¸€ä¸ªè¿”å›å€¼ï¼šæ–‡å­—çŠ¶æ€æè¿°ï¼ˆç”¨äºç›´è§‚å±•ç¤ºç”µæ± çŠ¶æ€ï¼‰
        - ç¬¬äºŒä¸ªè¿”å›å€¼ï¼šçŠ¶æ€æ ‡è¯†ç¬¦å·ï¼ˆé€šè¿‡é¢œè‰²/emojiåŒºåˆ†å‘Šè­¦çº§åˆ«ï¼Œæå‡å¯è¯»æ€§ï¼‰
        çŠ¶æ€åˆ†çº§æ ‡å‡†ï¼š
        1. æ»¡ç”µï¼šç”µé‡â‰¥95%ï¼Œæ­£å¸¸å·¥ä½œçŠ¶æ€
        2. æ­£å¸¸ï¼š20%â‰¤ç”µé‡<95%ï¼Œå¯æ­£å¸¸æ‰§è¡Œä½œä¸š
        3. ä½ç”µé‡ï¼š5%â‰¤ç”µé‡<20%ï¼Œéœ€å‡†å¤‡å……ç”µ
        4. ç´§æ€¥ï¼šç”µé‡<5%ï¼Œéœ€ç«‹å³åœæ­¢ä½œä¸šå¹¶å……ç”µ
        """
        if self.battery_percent >= 95:
            return "æ»¡ç”µ", "ğŸŸ¢"
        elif 20 <= self.battery_percent < 95:
            return "æ­£å¸¸", "ğŸŸ¢"
        elif 5 <= self.battery_percent < 20:
            return "ä½ç”µé‡", "ğŸŸ¡"
        else:
            return "ç´§æ€¥ï¼ˆè¯·å……ç”µï¼‰", "ğŸ”´"

    def display_battery_info(self):
        """å¯è§†åŒ–å±•ç¤ºç”µæ± å®Œæ•´ç›‘æ§ä¿¡æ¯
        å±•ç¤ºå†…å®¹ï¼š
        1. ç”µæ± å®æ—¶ç”µå‹
        2. å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”åŠå¯è§†åŒ–è¿›åº¦æ¡
        3. ç”µæ± å½“å‰å·¥ä½œçŠ¶æ€ï¼ˆå«çŠ¶æ€æ ‡è¯†ï¼‰
        4. ç´§æ€¥å‘Šè­¦æç¤ºï¼ˆç”µé‡<5%æ—¶è§¦å‘ï¼‰
        ä¼˜åŒ–ç‰¹æ€§ï¼š
        - è¿›åº¦æ¡å¯è§†åŒ–æå‡ä¿¡æ¯å¯è¯»æ€§
        - ç´§æ€¥å‘Šè­¦å¼ºåŒ–ä½¿ç”¨å®‰å…¨æ€§ï¼Œæé†’ç”¨æˆ·åŠæ—¶å¤„ç†
        å¯é€‰é…ç½®ï¼š
        - å¯å¯ç”¨æ§åˆ¶å°æ¸…å±åŠŸèƒ½ï¼Œå®ç°ç›‘æ§ä¿¡æ¯å®æ—¶åˆ·æ–°ï¼ˆå·²æ³¨é‡Šï¼ŒæŒ‰éœ€å¯ç”¨ï¼‰
        """
        # æ¸…ç©ºæ§åˆ¶å°å±å¹•ï¼ˆå¯é€‰åŠŸèƒ½ï¼Œæ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯é€‰æ‹©æ˜¯å¦å¯ç”¨ï¼‰
        # å…¼å®¹Windowsï¼ˆclså‘½ä»¤ï¼‰å’ŒLinux/macOSï¼ˆclearå‘½ä»¤ï¼‰ç³»ç»Ÿ
        # import os
        # os.system('cls' if os.name == 'nt' else 'clear')

        # ç”µé‡è¿›åº¦æ¡å¯è§†åŒ–é…ç½®
        bar_length = 20  # è¿›åº¦æ¡æ€»é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ï¼Œå¯æ ¹æ®æ˜¾ç¤ºéœ€æ±‚è°ƒæ•´
        filled_length = int(bar_length * self.battery_percent // 100)  # å·²å¡«å……è¿›åº¦çš„å­—ç¬¦é•¿åº¦
        battery_bar = "â–ˆ" * filled_length + "-" * (bar_length - filled_length)  # æ‹¼æ¥è¿›åº¦æ¡å­—ç¬¦

        # è·å–å½“å‰ç”µæ± çŠ¶æ€æè¿°å’ŒçŠ¶æ€æ ‡è¯†ç¬¦å·
        status, color = self.get_battery_status()

        # æ‰“å°æ ¼å¼åŒ–åçš„ç”µæ± ç›‘æ§ä¿¡æ¯ï¼Œæ’ç‰ˆæ¸…æ™°ä¾¿äºæŸ¥çœ‹
        print(f"\n=== æ— äººè½¦ç”µæ± çŠ¶æ€ç›‘æ§ ===")
        print(f"å½“å‰ç”µå‹: {self.current_voltage}V")
        print(f"å‰©ä½™ç”µé‡: |{battery_bar}| {self.battery_percent}%")
        print(f"çŠ¶æ€: {color} {status}")

        # ç´§æ€¥å‘Šè­¦ï¼šç”µé‡ä½äº5%æ—¶ï¼Œæç¤ºç”¨æˆ·ç«‹å³åœæ­¢ä½œä¸šå¹¶æ¥å…¥å……ç”µå™¨ï¼Œé¿å…ç”µæ± è¿‡æ”¾æŸå
        if self.battery_percent < 5:
            print("âš ï¸  ã€ç´§æ€¥å‘Šè­¦ã€‘ç”µé‡è¿‡ä½ï¼Œç«‹å³åœæ­¢æ‰€æœ‰ä½œä¸šå¹¶æ¥å…¥å……ç”µå™¨ï¼")


def main():
    """ç¨‹åºä¸»å…¥å£ï¼Œå®ç°ç”µæ± çŠ¶æ€å¾ªç¯ç›‘æ§
    æ ¸å¿ƒæµç¨‹ï¼š
    1. åˆå§‹åŒ–æ— äººè½¦ç”µæ± ç®¡ç†å®ä¾‹
    2. å¾ªç¯æ‰§è¡Œã€Œç”µå‹è¯»å–â†’ç”µé‡è®¡ç®—â†’ä¿¡æ¯å±•ç¤ºã€æµç¨‹
    3. æ¯ç§’åˆ·æ–°ä¸€æ¬¡ç›‘æ§æ•°æ®ï¼Œä¿è¯å®æ—¶æ€§
    é€€å‡ºæœºåˆ¶ï¼š
    - æ”¯æŒé€šè¿‡Ctrl+Cå¿«æ·é”®æ•è·ä¸­æ–­ä¿¡å·ï¼Œå®ç°ç¨‹åºå‹å¥½é€€å‡ºï¼Œé¿å…å¼‚å¸¸æŠ¥é”™
    è¿è¡Œæç¤ºï¼š
    - å¯åŠ¨åä¼šè¾“å‡ºç³»ç»Ÿå¯åŠ¨æç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·é€€å‡ºæ–¹å¼
    """
    # åˆå§‹åŒ–æ— äººè½¦ç”µæ± ç®¡ç†å®ä¾‹ï¼ŒåŠ è½½ç”µæ± æ ¸å¿ƒé…ç½®å‚æ•°
    battery = UnmannedVehicleBattery()
    print("æ— äººè½¦ç”µé‡ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨...ï¼ˆæŒ‰Ctrl+Cå¯é€€å‡ºç›‘æ§ï¼‰")

    try:
        # æ— é™å¾ªç¯æ‰§è¡Œç›‘æ§æµç¨‹ï¼Œæ¯ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®ï¼Œå®ç°æŒç»­ç›‘æ§
        while True:
            battery.read_battery_voltage()  # æ­¥éª¤1ï¼šè¯»å–ç”µæ± å®æ—¶ç”µå‹ï¼ˆæ¨¡æ‹Ÿ/ç¡¬ä»¶é‡‡é›†ï¼‰
            battery.calculate_battery_percent()  # æ­¥éª¤2ï¼šæ ¹æ®ç”µå‹è®¡ç®—å‰©ä½™ç”µé‡ç™¾åˆ†æ¯”
            battery.display_battery_info()  # æ­¥éª¤3ï¼šå¯è§†åŒ–å±•ç¤ºç”µæ± å®Œæ•´ç›‘æ§ä¿¡æ¯
            time.sleep(1)  # æš‚åœ1ç§’ï¼Œæ§åˆ¶ç›‘æ§åˆ·æ–°é¢‘ç‡
    except KeyboardInterrupt:
        # æ•è·Ctrl+Cä¸­æ–­ä¿¡å·ï¼Œæ‰“å°é€€å‡ºæç¤ºï¼Œå®ç°ç¨‹åºæ­£å¸¸é€€å‡º
        print("\nç›‘æ§ç³»ç»Ÿå·²æ­£å¸¸é€€å‡º")


if __name__ == "__main__":
    # ç¨‹åºå¯åŠ¨å…¥å£ï¼šå½“è„šæœ¬ç›´æ¥è¿è¡Œæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œä¸»å‡½æ•°å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
    # è‹¥ä½œä¸ºæ¨¡å—å¯¼å…¥æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä¾¿äºå¤ç”¨ç±»å’Œæ–¹æ³•
    main()