<launch>
  <!-- =====================================================================
       CARLA + Gmapping SLAM 建图系统
       功能：使用gmapping算法基于激光雷达数据构建2D栅格地图
       
       作业要求：
       - 在CARLA仿真环境中实现SLAM建图
       - 使用gmapping功能包（输入：激光雷达+里程计，输出：2D栅格地图）
       - 完成建图后使用map_saver保存地图
       ===================================================================== -->

  <!-- ====================== 公共参数配置 ====================== -->
  <arg name="role_name" default="ego_vehicle"/>
  
  <!-- ====================== CARLA 连接参数 ====================== -->
  <arg name="host" default="localhost"/>
  <arg name="port" default="2000"/>
  <arg name="timeout" default="60"/>
  <arg name="town" default="Town01"/>
  
  <!-- ====================== 车辆生成参数 ====================== -->
  <arg name="objects_definition_file" default='$(find carla_spawn_objects)/config/objects.json'/>
  <arg name="spawn_point_ego_vehicle" default=""/>
  <arg name="spawn_sensors_only" default="false"/>

  <!-- ====================== 同步模式参数 ====================== -->
  <arg name="synchronous_mode" default="True"/>
  <arg name="synchronous_mode_wait_for_vehicle_control_command" default="False"/>
  <arg name="fixed_delta_seconds" default="0.05"/>

  <!-- ====================== SLAM参数 ====================== -->
  <!-- 地图分辨率（米/像素） -->
  <arg name="map_resolution" default="0.05"/>
  <!-- 地图更新频率 -->
  <arg name="map_update_interval" default="2.0"/>

  <!-- 设置仿真时间源为CARLA -->
  <param name="use_sim_time" value="True"/>


  <!-- ====================== 1. CARLA ROS Bridge ====================== -->
  <node 
    pkg="carla_ros_bridge" 
    name="carla_ros_bridge" 
    type="bridge.py" 
    output="screen" 
    required="true"
  >
    <param name="host" value="$(arg host)"/>
    <param name="port" value="$(arg port)"/>
    <param name="timeout" value="$(arg timeout)"/>
    <param name="passive" value="False"/>
    <param name="synchronous_mode" value="$(arg synchronous_mode)"/>
    <param name="synchronous_mode_wait_for_vehicle_control_command" value="$(arg synchronous_mode_wait_for_vehicle_control_command)"/>
    <param name="fixed_delta_seconds" value="$(arg fixed_delta_seconds)"/>
    <param name="register_all_sensors" value="True"/>
    <param name="town" value="$(arg town)"/>
    <param name="ego_vehicle_role_name" value='["hero", "ego_vehicle", "hero0", "hero1", "hero2", "hero3", "hero4", "hero5", "hero6", "hero7", "hero8", "hero9"]'/>
  </node>


  <!-- ====================== 2. Spawn Objects（生成车辆和传感器） ====================== -->
  <node 
    pkg="carla_spawn_objects" 
    type="carla_spawn_objects.py" 
    name="$(anon carla_spawn_objects)" 
    output="screen"
    required="true"
    launch-prefix="bash -c 'sleep 3; $0 $@' "
  >
    <param name="objects_definition_file" value="$(arg objects_definition_file)" />
    <param name="spawn_point_$(arg role_name)" value="$(arg spawn_point_ego_vehicle)" />
    <param name="spawn_sensors_only" value="$(arg spawn_sensors_only)" />
    <param name="role_name" value="$(arg role_name)"/>
  </node>


  <!-- ====================== 3. Waypoint Publisher（暂时禁用，缺少networkx） ====================== -->
  <!-- 
  <node 
    pkg="carla_waypoint_publisher" 
    type="carla_waypoint_publisher.py" 
    name="carla_waypoint_publisher" 
    output="screen"
    launch-prefix="bash -c 'sleep 5; $0 $@' "
  >
    <param name="role_name" value="$(arg role_name)"/>
    <param name="host" value="$(arg host)"/>
    <param name="port" value="$(arg port)"/>
    <param name="timeout" value="$(arg timeout)"/>
  </node>
  -->


  <!-- ====================== 4. Manual Control（手动控制建图） ====================== -->
  <node 
    pkg="carla_manual_control" 
    type="carla_manual_control.py" 
    name="carla_manual_control_$(arg role_name)" 
    output="screen"
    required="true"
    launch-prefix="bash -c 'sleep 6; $0 $@' "
  >
    <param name="role_name" value="$(arg role_name)"/>
  </node>


  <!-- ====================== 5. PointCloud转LaserScan ====================== -->
  <!-- CARLA激光雷达输出PointCloud2，需要转换为LaserScan供gmapping使用 -->
  <node 
    pkg="pointcloud_to_laserscan" 
    type="pointcloud_to_laserscan_node" 
    name="pointcloud_to_laserscan"
    launch-prefix="bash -c 'sleep 8; $0 $@' "
  >
    <remap from="cloud_in" to="/carla/$(arg role_name)/lidar"/>
    <remap from="scan" to="/carla/$(arg role_name)/scan"/>
    <param name="min_height" value="-0.5"/>
    <param name="max_height" value="1.0"/>
    <param name="angle_min" value="-3.14159"/>
    <param name="angle_max" value="3.14159"/>
    <param name="angle_increment" value="0.0087"/>
    <param name="scan_time" value="0.1"/>
    <param name="range_min" value="0.5"/>
    <param name="range_max" value="100.0"/>
    <param name="use_inf" value="true"/>
    <param name="target_frame" value="$(arg role_name)/lidar"/>
  </node>


  <!-- ====================== 6. Gmapping SLAM节点 ====================== -->
  <!-- gmapping算法：输入激光雷达+里程计，输出2D栅格地图 -->
  <node 
    pkg="gmapping" 
    type="slam_gmapping" 
    name="slam_gmapping" 
    output="screen"
    launch-prefix="bash -c 'sleep 10; $0 $@' "
  >
    <!-- 输入话题映射 -->
    <remap from="scan" to="/carla/$(arg role_name)/scan"/>
    <remap from="odom" to="/carla/$(arg role_name)/odometry"/>
    
    <!-- 坐标系设置 -->
    <param name="base_frame" value="$(arg role_name)"/>
    <param name="odom_frame" value="odom"/>
    <param name="map_frame" value="map"/>
    
    <!-- 地图参数 -->
    <param name="map_update_interval" value="$(arg map_update_interval)"/>
    <param name="maxUrange" value="50.0"/>
    <param name="maxRange" value="100.0"/>
    <param name="sigma" value="0.05"/>
    <param name="kernelSize" value="1"/>
    <param name="lstep" value="0.05"/>
    <param name="astep" value="0.05"/>
    <param name="iterations" value="5"/>
    <param name="lsigma" value="0.075"/>
    <param name="ogain" value="3.0"/>
    <param name="lskip" value="0"/>
    
    <!-- 粒子滤波器参数 -->
    <param name="particles" value="30"/>
    <param name="minimumScore" value="50"/>
    
    <!-- 地图尺寸 -->
    <param name="xmin" value="-50.0"/>
    <param name="ymin" value="-50.0"/>
    <param name="xmax" value="50.0"/>
    <param name="ymax" value="50.0"/>
    <param name="delta" value="$(arg map_resolution)"/>
    
    <!-- 运动模型参数 -->
    <param name="linearUpdate" value="0.5"/>
    <param name="angularUpdate" value="0.3"/>
    <param name="temporalUpdate" value="-1.0"/>
    <param name="resampleThreshold" value="0.5"/>
  </node>


  <!-- ====================== 6. TF变换发布（如果需要） ====================== -->
  <!-- 发布base_link到激光雷达的变换 -->
  <node 
    pkg="tf" 
    type="static_transform_publisher" 
    name="base_to_lidar" 
    args="0 0 0.5 0 0 0 $(arg role_name) $(arg role_name)/lidar 100"
    launch-prefix="bash -c 'sleep 7; $0 $@' "
  />

</launch>
