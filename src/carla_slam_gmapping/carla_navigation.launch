<launch>
  <!-- =====================================================================
       CARLA + AMCL + Move_Base 导航系统
       功能：基于已保存的地图实现自主导航
       
       作业要求：
       - 在已建立的地图上实现自主导航
       - 使用AMCL进行定位
       - 使用move_base进行路径规划和运动控制
       
       前提条件：
       1. 已使用SLAM建图并保存地图文件
       2. 地图文件保存在maps文件夹中
       ===================================================================== -->

  <!-- ====================== 公共参数配置 ====================== -->
  <arg name="role_name" default="ego_vehicle"/>
  
  <!-- ====================== CARLA 连接参数 ====================== -->
  <arg name="host" default="localhost"/>
  <arg name="port" default="2000"/>
  <arg name="timeout" default="60"/>
  <arg name="town" default="Town01"/>
  
  <!-- ====================== 车辆生成参数 ====================== -->
  <arg name="objects_definition_file" default='$(find carla_spawn_objects)/config/objects.json'/>
  <arg name="spawn_point_ego_vehicle" default=""/>
  <arg name="spawn_sensors_only" default="false"/>

  <!-- ====================== 同步模式参数 ====================== -->
  <arg name="synchronous_mode" default="True"/>
  <arg name="synchronous_mode_wait_for_vehicle_control_command" default="False"/>
  <arg name="fixed_delta_seconds" default="0.05"/>

  <!-- ====================== 导航参数 ====================== -->
  <!-- 地图文件名（不包含扩展名） -->
  <arg name="map_file" default="$(find carla_spawn_objects)/maps/carla_map.yaml"/>
  
  <!-- 初始位置估计 -->
  <arg name="initial_pose_x" default="0.0"/>
  <arg name="initial_pose_y" default="0.0"/>
  <arg name="initial_pose_a" default="0.0"/>

  <!-- 设置仿真时间源为CARLA -->
  <param name="use_sim_time" value="True"/>


  <!-- ====================== 1. CARLA ROS Bridge ====================== -->
  <node 
    pkg="carla_ros_bridge" 
    name="carla_ros_bridge" 
    type="bridge.py" 
    output="screen" 
    required="true"
  >
    <param name="host" value="$(arg host)"/>
    <param name="port" value="$(arg port)"/>
    <param name="timeout" value="$(arg timeout)"/>
    <param name="passive" value="False"/>
    <param name="synchronous_mode" value="$(arg synchronous_mode)"/>
    <param name="synchronous_mode_wait_for_vehicle_control_command" value="$(arg synchronous_mode_wait_for_vehicle_control_command)"/>
    <param name="fixed_delta_seconds" value="$(arg fixed_delta_seconds)"/>
    <param name="register_all_sensors" value="True"/>
    <param name="town" value="$(arg town)"/>
    <param name="ego_vehicle_role_name" value='["hero", "ego_vehicle", "hero0", "hero1", "hero2", "hero3", "hero4", "hero5", "hero6", "hero7", "hero8", "hero9"]'/>
  </node>


  <!-- ====================== 2. Spawn Objects（生成车辆和传感器） ====================== -->
  <node 
    pkg="carla_spawn_objects" 
    type="carla_spawn_objects.py" 
    name="$(anon carla_spawn_objects)" 
    output="screen"
    required="true"
    launch-prefix="bash -c 'sleep 3; $0 $@' "
  >
    <param name="objects_definition_file" value="$(arg objects_definition_file)" />
    <param name="spawn_point_$(arg role_name)" value="$(arg spawn_point_ego_vehicle)" />
    <param name="spawn_sensors_only" value="$(arg spawn_sensors_only)" />
    <param name="role_name" value="$(arg role_name)"/>
  </node>


  <!-- ====================== 3. Waypoint Publisher ====================== -->
  <node 
    pkg="carla_waypoint_publisher" 
    type="carla_waypoint_publisher.py" 
    name="carla_waypoint_publisher" 
    output="screen"
    launch-prefix="bash -c 'sleep 5; $0 $@' "
  >
    <param name="role_name" value="$(arg role_name)"/>
    <param name="host" value="$(arg host)"/>
    <param name="port" value="$(arg port)"/>
    <param name="timeout" value="$(arg timeout)"/>
  </node>


  <!-- ====================== 4. PointCloud转LaserScan ====================== -->
  <!-- CARLA激光雷达输出PointCloud2，需要转换为LaserScan -->  
  <node 
    pkg="pointcloud_to_laserscan" 
    type="pointcloud_to_laserscan_node" 
    name="pointcloud_to_laserscan"
    launch-prefix="bash -c 'sleep 6; $0 $@' "
  >
    <remap from="cloud_in" to="/carla/$(arg role_name)/lidar"/>
    <remap from="scan" to="/carla/$(arg role_name)/scan"/>
    <param name="min_height" value="-0.5"/>
    <param name="max_height" value="1.0"/>
    <param name="angle_min" value="-3.14159"/>
    <param name="angle_max" value="3.14159"/>
    <param name="angle_increment" value="0.0087"/>
    <param name="scan_time" value="0.1"/>
    <param name="range_min" value="0.5"/>
    <param name="range_max" value="100.0"/>
    <param name="use_inf" value="true"/>
    <param name="target_frame" value="$(arg role_name)/lidar"/>
  </node>


  <!-- ====================== 5. Map Server（地图服务器） ====================== -->
  <!-- 加载已保存的地图 -->
  <node 
    pkg="map_server" 
    type="map_server" 
    name="map_server" 
    output="screen"
    args="$(arg map_file)"
    launch-prefix="bash -c 'sleep 6; $0 $@' "
  >
    <param name="frame_id" value="map"/>
  </node>


  <!-- ====================== 6. AMCL定位节点 ====================== -->
  <!-- 蒙特卡洛定位算法 -->
  <node 
    pkg="amcl" 
    type="amcl" 
    name="amcl" 
    output="screen"
    launch-prefix="bash -c 'sleep 7; $0 $@' "
  >
    <!-- 输入话题映射 -->
    <remap from="scan" to="/carla/$(arg role_name)/scan"/>
    
    <!-- 坐标系设置 -->
    <param name="odom_frame_id" value="odom"/>
    <param name="base_frame_id" value="$(arg role_name)"/>
    <param name="global_frame_id" value="map"/>
    
    <!-- 初始位置 -->
    <param name="initial_pose_x" value="$(arg initial_pose_x)"/>
    <param name="initial_pose_y" value="$(arg initial_pose_y)"/>
    <param name="initial_pose_a" value="$(arg initial_pose_a)"/>
    
    <!-- 粒子滤波器参数 -->
    <param name="min_particles" value="500"/>
    <param name="max_particles" value="5000"/>
    <param name="kld_err" value="0.05"/>
    <param name="kld_z" value="0.99"/>
    
    <!-- 更新参数 -->
    <param name="update_min_d" value="0.2"/>
    <param name="update_min_a" value="0.5"/>
    <param name="resample_interval" value="1"/>
    
    <!-- 运动模型参数 -->
    <param name="odom_model_type" value="diff"/>
    <param name="odom_alpha1" value="0.2"/>
    <param name="odom_alpha2" value="0.2"/>
    <param name="odom_alpha3" value="0.2"/>
    <param name="odom_alpha4" value="0.2"/>
    
    <!-- 激光参数 -->
    <param name="laser_max_beams" value="60"/>
    <param name="laser_max_range" value="50.0"/>
    <param name="laser_min_range" value="0.5"/>
    <param name="laser_model_type" value="likelihood_field"/>
    <param name="laser_likelihood_max_dist" value="2.0"/>
    
    <!-- TF -->
    <param name="tf_broadcast" value="true"/>
    <param name="transform_tolerance" value="1.0"/>
    
    <!-- 恢复参数 -->
    <param name="recovery_alpha_slow" value="0.0"/>
    <param name="recovery_alpha_fast" value="0.0"/>
  </node>


  <!-- ====================== 7. Move Base导航节点 ====================== -->
  <!-- 路径规划和运动控制 -->
  <node 
    pkg="move_base" 
    type="move_base" 
    name="move_base" 
    output="screen"
    launch-prefix="bash -c 'sleep 8; $0 $@' "
  >
    <!-- 输入话题映射 -->
    <remap from="cmd_vel" to="/carla/$(arg role_name)/cmd_vel"/>
    <remap from="odom" to="/carla/$(arg role_name)/odometry"/>
    <remap from="scan" to="/carla/$(arg role_name)/scan"/>
    
    <!-- 参数文件加载 -->
    <rosparam file="$(find carla_spawn_objects)/config/costmap_common_params.yaml" command="load" ns="global_costmap"/>
    <rosparam file="$(find carla_spawn_objects)/config/costmap_common_params.yaml" command="load" ns="local_costmap"/>
    <rosparam file="$(find carla_spawn_objects)/config/global_costmap_params.yaml" command="load"/>
    <rosparam file="$(find carla_spawn_objects)/config/local_costmap_params.yaml" command="load"/>
    <rosparam file="$(find carla_spawn_objects)/config/dwa_local_planner_params.yaml" command="load"/>
    <rosparam file="$(find carla_spawn_objects)/config/move_base_params.yaml" command="load"/>
    
    <!-- 坐标系 -->
    <param name="global_costmap/robot_base_frame" value="$(arg role_name)"/>
    <param name="local_costmap/robot_base_frame" value="$(arg role_name)"/>
  </node>


  <!-- ====================== 7. TF变换发布 ====================== -->
  <node 
    pkg="tf" 
    type="static_transform_publisher" 
    name="base_to_lidar" 
    args="0 0 0.5 0 0 0 $(arg role_name) $(arg role_name)/lidar 100"
    launch-prefix="bash -c 'sleep 6; $0 $@' "
  />

</launch>
